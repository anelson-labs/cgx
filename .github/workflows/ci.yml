name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Stage 0: Detect PR type to determine which CI path to use
  #
  # Security model for dependabot PRs:
  # - We use `github.actor == 'dependabot[bot]'` to detect dependabot commits
  # - This is secure because GitHub protects the [bot] namespace - third parties cannot impersonate it
  # - If anyone manually commits to a dependabot PR, github.actor changes to that person's username,
  #   which automatically triggers the full CI path instead of the minimal one
  # - Therefore, the minimal CI checks ONLY apply to 100% pure dependabot-originated commits
  # - Workflows run from the base branch, so malicious PRs cannot modify this detection logic
  detect-pr-type:
    name: Detect PR Type
    runs-on: ubuntu-24.04
    outputs:
      is-dependabot: ${{ steps.check.outputs.is-dependabot }}
    steps:
      - name: Check if PR is from dependabot
        id: check
        run: |
          if [ "${{ github.actor }}" == "dependabot[bot]" ]; then
            echo "is-dependabot=true" >> $GITHUB_OUTPUT
            echo "Detected dependabot PR - will use minimal CI checks"
          else
            echo "is-dependabot=false" >> $GITHUB_OUTPUT
            echo "Not a dependabot PR - will use full CI checks"
          fi

  # Stage 1a: Minimal dependency checks for dependabot PRs (Linux amd64 only)
  # This runs just depcheck, build, and unit tests to verify dependency updates don't break anything
  dependabot-quick-check:
    name: Dependabot Quick Check (Linux amd64)
    needs: detect-pr-type
    if: needs.detect-pr-type.outputs.is-dependabot == 'true'
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.85.1
          components: rustfmt, clippy

      - name: Install just
        uses: taiki-e/install-action@v2
        with:
          tool: just

      - name: Install cargo-deny
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-deny@0.19.0

      - name: Install cargo-machete
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-machete@0.8.0

      - uses: Swatinem/rust-cache@v2

      - name: Run dependency checks
        run: just depcheck

      - name: Build
        run: cargo build --workspace

      - name: Run unit tests
        run: cargo test --workspace --lib

  # Stage 1b: Platform verification for dependabot PRs (Mac/Windows check only, no tests)
  # This ensures the dependency update doesn't break compilation on other platforms
  dependabot-platform-check:
    name: Dependabot Platform Check (${{ matrix.name }})
    needs: [detect-pr-type, dependabot-quick-check]
    if: needs.detect-pr-type.outputs.is-dependabot == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-2025
            name: Windows amd64
          - os: macos-15
            name: Mac ARM64
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.85.1

      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.name }}

      - name: Check compilation
        run: cargo check --workspace

  # Stage 1: Lint and Format Check on Linux amd64, which is the cheapest and quickest build for us
  lint:
    name: Lint and Format Check
    needs: detect-pr-type
    if: needs.detect-pr-type.outputs.is-dependabot == 'false'
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6

      # dtolnay in his infinite wisdom did not think that CI builds should honor
      # rust-toolchain files, so we must specify the toolchain version here AND
      # in rust-toolchain.toml. Keep these in sync or face the consequences.
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.85.1
          components: rustfmt, clippy

      - name: Install just
        uses: taiki-e/install-action@v2
        with:
          tool: just

      - name: Install taplo
        uses: taiki-e/install-action@v2
        with:
          tool: taplo

      - uses: Swatinem/rust-cache@v2

      - name: Run vibecheck
        run: just vibecheck

      - name: Check formatting
        run: just fmtcheck

      - name: Check TOML formatting
        run: taplo fmt --check

      - name: Install cargo-deny
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-deny@0.19.0

      - name: Install cargo-machete
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-machete@0.8.0

      - name: Run dependency checks
        run: just depcheck

  # Stage 2: Linux amd64 Build and Test.  This will catch most build issues and broken tests,
  # before we we move on to the more expensive and slower platform-specific builds and tests.
  test-linux-amd64:
    name: Test (Linux amd64)
    needs: [detect-pr-type, lint]
    if: needs.detect-pr-type.outputs.is-dependabot == 'false'
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6

      # dtolnay in his infinite wisdom did not think that CI builds should honor
      # rust-toolchain files, so we must specify the toolchain version here AND
      # in rust-toolchain.toml. Keep these in sync or face the consequences.
      - &install-rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.85.1
          components: rustfmt, clippy

      - name: Install just
        uses: taiki-e/install-action@v2
        with:
          tool: just

      - uses: Swatinem/rust-cache@v2

      - name: Build
        run: cargo build --workspace

      - name: Run tests
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: cargo test --workspace

  # Stage 3: Tier 1 Platforms (Windows amd64, Mac ARM64, Linux musl)
  # Not to be confused with Rust "Tier 1" platforms, these are just the selection of platforms, after
  # Linux amd64, that are most likely to catch paltform-specific breakage.
  test-tier1-platforms:
    name: Test (Tier 1 ${{ matrix.name }})
    needs: [detect-pr-type, test-linux-amd64]
    if: needs.detect-pr-type.outputs.is-dependabot == 'false'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-2025
            name: Windows amd64
          - os: windows-2025
            name: Windows GNU amd64
            target: x86_64-pc-windows-gnu
          - os: macos-15
            name: Mac ARM64
          - os: ubuntu-24.04
            name: Linux musl
            target: x86_64-unknown-linux-musl
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6

      - *install-rust

      - name: Install just
        uses: taiki-e/install-action@v2
        with:
          tool: just

      - name: Install musl tools
        if: matrix.target == 'x86_64-unknown-linux-musl'
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools

      - name: Add target
        if: matrix.target
        run: rustup target add ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.name }}

      # Run a vibecheck on each platform to ensure that platform-specific
      # code is also linted
      - name: Run vibecheck
        run: just vibecheck

      - name: Build
        env:
          TARGET_FLAG: ${{ matrix.target && format('--target {0}', matrix.target) || '' }}
        run: cargo build --workspace ${{ env.TARGET_FLAG }}

      - name: Run tests
        env:
          TARGET_FLAG: ${{ matrix.target && format('--target {0}', matrix.target) || '' }}
          GITHUB_TOKEN: ${{ github.token }}
        run: cargo test --workspace ${{ env.TARGET_FLAG }}

  # Stage 4: Lesser Platforms (ARM + Intel Mac)
  # These platforms are alternative architectures for the tier 1 targets, so in all likelihood work just as
  # well as the primary arch, but we need to build and test them anyway in the interest of being thorough.
  # There is no point wasting resources on these unless all of the tier 1 platforms have already passed.
  test-tier2-platforms:
    name: Test (Tier 2 ${{ matrix.name }})
    needs: [detect-pr-type, test-linux-amd64, test-tier1-platforms]
    if: needs.detect-pr-type.outputs.is-dependabot == 'false'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-11-arm
            name: Windows ARM64
          - os: ubuntu-24.04-arm
            name: Linux ARM64
          - os: macos-15-intel
            name: Mac Intel
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6

      - *install-rust

      - name: Install just
        uses: taiki-e/install-action@v2
        with:
          tool: just

      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.name }}

      # Run a vibecheck on each platform to ensure that platform-specific
      # code is also linted
      - name: Run vibecheck
        run: just vibecheck

      - name: Build
        run: cargo build --workspace

      - name: Run tests
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: cargo test --workspace

  # Aggregate job that depends on all previous builds.  This is the check that
  # must pass for the PR to be considered successful.
  # This job is configured as the required status check for branch protection.
  # It checks different sets of jobs depending on whether the PR is from dependabot or not.
  build-test:
    name: Build and Test
    needs:
      [
        detect-pr-type,
        dependabot-quick-check,
        dependabot-platform-check,
        test-linux-amd64,
        test-tier1-platforms,
        test-tier2-platforms,
      ]
    runs-on: ubuntu-24.04
    if: always()
    steps:
      - name: Check appropriate tests passed
        run: |
          IS_DEPENDABOT="${{ needs.detect-pr-type.outputs.is-dependabot }}"

          if [ "$IS_DEPENDABOT" == "true" ]; then
            echo "Checking minimal CI for dependabot PR..."
            # For dependabot PRs, only check the minimal jobs
            if [ "${{ needs.dependabot-quick-check.result }}" != "success" ] || \
               [ "${{ needs.dependabot-platform-check.result }}" != "success" ]; then
              echo "One or more dependabot checks failed"
              exit 1
            fi
            echo "All dependabot checks passed"
          else
            echo "Checking full CI for regular PR..."
            # For regular PRs, check all full CI jobs
            if [ "${{ needs.test-linux-amd64.result }}" != "success" ] || \
               [ "${{ needs.test-tier1-platforms.result }}" != "success" ] || \
               [ "${{ needs.test-tier2-platforms.result }}" != "success" ]; then
              echo "One or more test jobs failed"
              exit 1
            fi
            echo "All builds and tests passed"
          fi
